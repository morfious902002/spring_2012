<!DOCTYPE html>
<html id="sv"><head>
	<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
    <title>#250 Authentication from Scratch (revised) - RailsCasts</title>
    <meta name="description" content="Short Ruby on Rails screencasts containing tips, tricks and tutorials. Great for both novice and experienced web developers.">
    <meta name="keywords" content="rails, ruby on rails, screencasts, railscast, railscasts, tips, tricks, tutorials, training, podcasts, programming">
    <link rel="alternate" type="application/rss+xml" title="Episodes RSS" href="http://feeds.feedburner.com/railscasts">
    <link href="250-authentication-from-scratch-revised_files/application.css" media="screen" rel="stylesheet" type="text/css">
<link href="250-authentication-from-scratch-revised_files/coderay.css" media="screen" rel="stylesheet" type="text/css">
    <script src="250-authentication-from-scratch-revised_files/jquery.js" type="text/javascript"></script>
<script src="250-authentication-from-scratch-revised_files/jquery_002.js" type="text/javascript"></script>
<script src="250-authentication-from-scratch-revised_files/rails.js" type="text/javascript"></script>
    <script src="250-authentication-from-scratch-revised_files/3s7oes9q.js" type="text/javascript"></script>
    <script src="250-authentication-from-scratch-revised_files/application.js" type="text/javascript"></script>
    <meta name="csrf-param" content="authenticity_token">
<meta name="csrf-token" content="WIiZcsBSKcFeoihsK5K8mOA3Hb2wJdvHzKQ/q7AOw4I=">
    
  <script src="250-authentication-from-scratch-revised_files/sublime.js" type="text/javascript"></script></head>
  <body data-twttr-rendered="true">
    <div id="top">
      <div class="logo"><a href="http://railscasts.com/"><img alt="RailsCasts - Ruby on Rails Screencasts" src="250-authentication-from-scratch-revised_files/railscasts_logo.png" height="56" width="423"></a></div>
      <div class="user_nav">
          Logged in as <a href="http://railscasts.com/users/4983">Mitch Marx</a>
            | <a href="http://railscasts.com/comments">Recent Comments</a>
          |
            <a href="https://railscasts.com/subscriptions/current">Manage Subscription</a>
          | <a href="http://railscasts.com/logout">Log Out</a>
      </div>
      <ul class="subscribe horizontal">
        <li>
          <a href="http://phobos.apple.com/WebObjects/MZStore.woa/wa/viewPodcast?id=218282043"><img alt="Itunes" src="250-authentication-from-scratch-revised_files/itunes.png" height="34" width="34"></a>
          <span class="name">watch on iTunes</span>
        </li>
        <li>
          <a href="http://twitter.com/railscasts"><img alt="Twitter" src="250-authentication-from-scratch-revised_files/twitter.png" height="34" width="34"></a>
          <span class="name">follow on Twitter</span>
        </li>
        <li>
          <a href="http://www.facebook.com/pages/railscasts/197415140659"><img alt="Facebook" src="250-authentication-from-scratch-revised_files/facebook.png" height="34" width="34"></a>
          <span class="name">follow on Facebook</span>
        </li>
        <li>
          <a href="http://feeds.feedburner.com/railscasts"><img alt="Rss" src="250-authentication-from-scratch-revised_files/rss.png" height="34" width="34"></a>
          <span class="name">subscribe to RSS feed</span>
        </li>
      </ul>
    </div>

    <div id="nav_bar">
      <ul class="nav horizontal">
        <li><a href="http://railscasts.com/">Browse Episodes</a></li>
        <li><a href="http://railscasts.com/pro">RailsCasts Pro</a></li>
        <li><a href="http://railscasts.com/about">About</a></li>
        <li><a href="http://railscasts.com/feedback">Feedback</a></li>
      </ul>
      <form accept-charset="UTF-8" action="/episodes" method="get"><div style="margin:0;padding:0;display:inline"><input name="utf8" value="✓" type="hidden"></div>
        <input id="search" name="search" size="35" type="text">
        <input value="Search Episodes" type="submit">
</form>    </div>


    <div id="main">

      
  <div id="episode">
    <script id="video_template" type="text/html"><video width="960" height="600" poster="/assets/episodes/posters/loading.png" controls="controls" preload="none" class="sv_force_flash"><source src="http://media.railscasts.com/assets/subscriptions/ztjiIGras9Eyz09CVpsDzQ/videos/250-authentication-from-scratch-revised.mp4" type="video/mp4"/><source src="http://media.railscasts.com/assets/subscriptions/ztjiIGras9Eyz09CVpsDzQ/videos/250-authentication-from-scratch-revised.m4v" type="video/mp4"/><source src="http://media.railscasts.com/assets/subscriptions/ztjiIGras9Eyz09CVpsDzQ/videos/250-authentication-from-scratch-revised.webm" type="video/webm"/><source src="http://media.railscasts.com/assets/subscriptions/ztjiIGras9Eyz09CVpsDzQ/videos/250-authentication-from-scratch-revised.ogv" type="video/ogg"/></video></script>
    <div class="info">
      <div class="screenshot"><a href="http://railscasts.com/episodes/250-authentication-from-scratch-revised?autoplay=true" class="play_video"><img alt="Authentication from Scratch (revised)" src="250-authentication-from-scratch-revised_files/250-authentication-from-scratch-revised.png" height="125" width="200"></a></div>
      <h1><span class="position">#250</span> Authentication from Scratch (revised)</h1>
      <div class="details">Feb 25, 2012 | 13 minutes | <a href="http://railscasts.com/?tag_id=25">Authentication</a></div>
      <div class="description">Simple password authentication is easy to
 do with has_secure_password. Here you will learn how to make a complete
 Sign Up, Log In, and Log Out process as well as restrict access to 
certain actions.</div>
      <div class="watch"><a href="http://railscasts.com/episodes/250-authentication-from-scratch-revised?autoplay=true" class="play_video pretty_button">Click to Play Video ▶</a></div>
      <div class="social"><iframe title="Twitter Tweet Button" style="width: 107px; height: 20px;" class="twitter-share-button twitter-count-horizontal" src="250-authentication-from-scratch-revised_files/tweet_button.html" allowtransparency="true" frameborder="0" scrolling="no"></iframe><script src="250-authentication-from-scratch-revised_files/widgets.js" type="text/javascript"></script></div>
        <ul class="downloads horizontal">
          <li>Download:</li>
          <li><a href="http://media.railscasts.com/assets/episodes/sources/250-authentication-from-scratch-revised.zip">source code</a><span class="overlay">Project Files in Zip (102 KB)</span></li><li><a href="http://media.railscasts.com/assets/subscriptions/ztjiIGras9Eyz09CVpsDzQ/videos/250-authentication-from-scratch-revised.mp4">mp4</a><span class="overlay">Full Size H.264 Video (25 MB)</span></li><li><a href="http://media.railscasts.com/assets/subscriptions/ztjiIGras9Eyz09CVpsDzQ/videos/250-authentication-from-scratch-revised.m4v">m4v</a><span class="overlay">Smaller H.264 Video (14.4 MB)</span></li><li><a href="http://media.railscasts.com/assets/subscriptions/ztjiIGras9Eyz09CVpsDzQ/videos/250-authentication-from-scratch-revised.webm">webm</a><span class="overlay">Full Size VP8 Video (17.5 MB)</span></li><li><a href="http://media.railscasts.com/assets/subscriptions/ztjiIGras9Eyz09CVpsDzQ/videos/250-authentication-from-scratch-revised.ogv">ogv</a><span class="overlay">Full Size Theora Video (30.7 MB)</span></li>
        </ul>
      <div class="clear"></div>
</div>    <ul class="nav horizontal"><li class="selected"><a href="http://railscasts.com/episodes/250-authentication-from-scratch-revised" class="tab">Show Notes</a></li><li><a href="http://railscasts.com/episodes/250-authentication-from-scratch-revised?view=asciicast" class="selected tab">ASCIIcast</a></li><li><a href="http://railscasts.com/episodes/250-authentication-from-scratch-revised?view=comments" class="tab">29 Comments</a></li><li><a href="http://railscasts.com/episodes/250-authentication-from-scratch-revised?view=similar" class="tab">Similar Episodes</a></li><li class="next"><a href="http://railscasts.com/episodes/251-metawhere-metasearch">Next Episode &gt;</a></li><li class="previous"><a href="http://railscasts.com/episodes/249-notifications-in-rails-3">&lt; Previous Episode</a></li></ul>
    <div class="nav_section">  <div class="asciicast">
    <p>User authentication is required in almost every Rails 
application, including the blogging application shown below. This app 
currently has no authentication at all and we want to add some so that 
users can sign up and then log in to and out of the site.</p>

<div class="imageWrapper">
  <img src="250-authentication-from-scratch-revised_files/E250RI01.png" alt="Our blogging application." height="463" width="800">
</div>

<p>There are several gems that will help us to add authentication to an 
app, such as Devise and OmniAuth. Sometimes though we just need simple 
password-based authentication and in these cases it’s not difficult to 
create it from scratch. We’ll do just that in this episode.</p>

<h3>Adding a Signup Form</h3>

<p>The first thing we need to do is to add a sign-up form for creating a
 new user and then add a link to it. This means that we’ll need to 
generate a <code>User</code> model and a controller to handle the signup
 process. We’ll use the resource generator to do this. This is similar 
to the scaffold generator but it doesn’t fill in all the controller 
actions. We’ll give the <code>User</code> model <code>email</code> and <code>password_digest</code> fields.</p>

      <div class="code_block">
        <div class="code_header">
          terminal
                <div id="clippy_1251738" class="clippy">
        <span style="display:none" class="clippy_code">$ rails g resource user email password_digest</span>
        <span class="clippy_label"></span>
        <object type="application/x-shockwave-flash" data="250-authentication-from-scratch-revised_files/clippy.swf" id="clippy_1251738_flash" height="14" width="14">
        <param name="movie" value="/flash/clippy.swf">
        <param name="allowScriptAccess" value="always">
        <param name="quality" value="high">
        <param name="scale" value="noscale">
        <param name="FlashVars" value="target=%23clippy_1251738">
        <param name="bgcolor" value="#E0E0E0">
        </object>
      </div>

        </div>
        <div class="CodeRay">
  <div class="code"><pre>$ rails g resource user email password_digest</pre></div>
</div>

      </div>

<p>Having a <code>password_digest</code> field is important as it’s the default name that’s used with Rails’ <code>has_secure_password</code> feature and we’ll be using this feature later. This command will generate a <code>User</code> model, a <code>UsersController</code> and a database migration. We’ll migrate the database before we continue.</p>

      <div class="code_block">
        <div class="code_header">
          terminal
                <div id="clippy_9182763" class="clippy">
        <span style="display:none" class="clippy_code">$ rake db:migrate</span>
        <span class="clippy_label"></span>
        <object type="application/x-shockwave-flash" data="250-authentication-from-scratch-revised_files/clippy.swf" id="clippy_9182763_flash" height="14" width="14">
        <param name="movie" value="/flash/clippy.swf">
        <param name="allowScriptAccess" value="always">
        <param name="quality" value="high">
        <param name="scale" value="noscale">
        <param name="FlashVars" value="target=%23clippy_9182763">
        <param name="bgcolor" value="#E0E0E0">
        </object>
      </div>

        </div>
        <div class="CodeRay">
  <div class="code"><pre>$ rake db:migrate</pre></div>
</div>

      </div>

<p>Next we’ll add <code>has_secure_password</code> to the User model. This was introduced in Rails 3.1 and adds some simple authentication support to the model using that <code>password_digest</code> column.</p>

      <div class="code_block">
        <div class="code_header">
          /app/models/user.rb
                <div id="clippy_6627896" class="clippy">
        <span style="display:none" class="clippy_code">class User &lt; ActiveRecord::Base
  has_secure_password
end</span>
        <span class="clippy_label"></span>
        <object type="application/x-shockwave-flash" data="250-authentication-from-scratch-revised_files/clippy.swf" id="clippy_6627896_flash" height="14" width="14">
        <param name="movie" value="/flash/clippy.swf">
        <param name="allowScriptAccess" value="always">
        <param name="quality" value="high">
        <param name="scale" value="noscale">
        <param name="FlashVars" value="target=%23clippy_6627896">
        <param name="bgcolor" value="#E0E0E0">
        </object>
      </div>

        </div>
        <div class="CodeRay">
  <div class="code"><pre><span class="r">class</span> <span class="cl">User</span> &lt; <span class="co">ActiveRecord</span>::<span class="co">Base</span>
  has_secure_password
<span class="r">end</span></pre></div>
</div>

      </div>

<p>To get this working in Rails we’ll also need to modify the gemfile and uncomment the line that includes the <code>bcrypt-ruby</code> gem as this gem handles hashing the password before its stored in the database.</p>

      <div class="code_block">
        <div class="code_header">
          /Gemfile
                <div id="clippy_8656013" class="clippy">
        <span style="display:none" class="clippy_code"># To use ActiveModel has_secure_password
gem 'bcrypt-ruby', '~&gt; 3.0.0'</span>
        <span class="clippy_label"></span>
        <object type="application/x-shockwave-flash" data="250-authentication-from-scratch-revised_files/clippy.swf" id="clippy_8656013_flash" height="14" width="14">
        <param name="movie" value="/flash/clippy.swf">
        <param name="allowScriptAccess" value="always">
        <param name="quality" value="high">
        <param name="scale" value="noscale">
        <param name="FlashVars" value="target=%23clippy_8656013">
        <param name="bgcolor" value="#E0E0E0">
        </object>
      </div>

        </div>
        <div class="CodeRay">
  <div class="code"><pre><span class="c"># To use ActiveModel has_secure_password</span>
gem <span class="s"><span class="dl">'</span><span class="k">bcrypt-ruby</span><span class="dl">'</span></span>, <span class="s"><span class="dl">'</span><span class="k">~&gt; 3.0.0</span><span class="dl">'</span></span></pre></div>
</div>

      </div>

<p>We need to run <code>bundle</code> to ensure that this gem is installed and to restart the server for the changes to be picked up.</p> 

<p>Another important change to make in the <code>User</code> model is to call <code>attr_accessible</code> and specify the attributes that can be set by mass assignment and through the form. We’ll set <code>email</code>, <code>password</code> and <code>password_confirmation</code> but you can set whatever fields you want to match your signup form.</p>

      <div class="code_block">
        <div class="code_header">
          /app/models/user.rb
                <div id="clippy_973119" class="clippy">
        <span style="display:none" class="clippy_code">class User &lt; ActiveRecord::Base
  has_secure_password
  
  attr_accessible :email, :password, :password_confirmation
  
  validates_uniqueness_of :email
end</span>
        <span class="clippy_label"></span>
        <object type="application/x-shockwave-flash" data="250-authentication-from-scratch-revised_files/clippy.swf" id="clippy_973119_flash" height="14" width="14">
        <param name="movie" value="/flash/clippy.swf">
        <param name="allowScriptAccess" value="always">
        <param name="quality" value="high">
        <param name="scale" value="noscale">
        <param name="FlashVars" value="target=%23clippy_973119">
        <param name="bgcolor" value="#E0E0E0">
        </object>
      </div>

        </div>
        <div class="CodeRay">
  <div class="code"><pre><span class="r">class</span> <span class="cl">User</span> &lt; <span class="co">ActiveRecord</span>::<span class="co">Base</span>
  has_secure_password
  
  attr_accessible <span class="sy">:email</span>, <span class="sy">:password</span>, <span class="sy">:password_confirmation</span>
  
  validates_uniqueness_of <span class="sy">:email</span>
<span class="r">end</span></pre></div>
</div>

      </div>

<p>Having this in place means that if we add an <code>admin</code> 
column to the database it won’t be possible for a malicious user to make
 themselves an admin user by sending a request including that value to 
the <code>UsersController</code>’s <code>update</code> action. We’ve 
also added a validation to the model to ensure that the email address is
 unique and we could add other validations here to validate the format 
of the email, the length of the password and so on. We don’t need to 
validate the presence of the <code>password</code> and <code>password_confirmation</code> fields, however, as this will be handled by <code>has_secure_password</code>.</p>

<p>Our <code>User</code> model is looking good so let’s move on to creating the signup form. We’ll do this inside the <code>UsersController</code>
 that we generated earlier. This is blank by default so we’ll need to 
add a couple of actions to handle creating new users. The code for these
 is fairly standard.</p>

      <div class="code_block">
        <div class="code_header">
          /app/controllers/users_controller.rb
                <div id="clippy_3664366" class="clippy">
        <span style="display:none" class="clippy_code">class UsersController &lt; ApplicationController
  def new
    @user = User.new
  end
  
  def create
    @user = User.new(params[:user])
    if @user.save
      redirect_to root_url, notice: "Thank you for signing up!"
    else
      render "new"
    end
  end
end</span>
        <span class="clippy_label"></span>
        <object type="application/x-shockwave-flash" data="250-authentication-from-scratch-revised_files/clippy.swf" id="clippy_3664366_flash" height="14" width="14">
        <param name="movie" value="/flash/clippy.swf">
        <param name="allowScriptAccess" value="always">
        <param name="quality" value="high">
        <param name="scale" value="noscale">
        <param name="FlashVars" value="target=%23clippy_3664366">
        <param name="bgcolor" value="#E0E0E0">
        </object>
      </div>

        </div>
        <div class="CodeRay">
  <div class="code"><pre><span class="r">class</span> <span class="cl">UsersController</span> &lt; <span class="co">ApplicationController</span>
  <span class="r">def</span> <span class="fu">new</span>
    <span class="iv">@user</span> = <span class="co">User</span>.new
  <span class="r">end</span>
  
  <span class="r">def</span> <span class="fu">create</span>
    <span class="iv">@user</span> = <span class="co">User</span>.new(params[<span class="sy">:user</span>])
    <span class="r">if</span> <span class="iv">@user</span>.save
      redirect_to root_url, <span class="sy">notice:</span> <span class="s"><span class="dl">"</span><span class="k">Thank you for signing up!</span><span class="dl">"</span></span>
    <span class="r">else</span>
      render <span class="s"><span class="dl">"</span><span class="k">new</span><span class="dl">"</span></span>
    <span class="r">end</span>
  <span class="r">end</span>
<span class="r">end</span></pre></div>
</div>

      </div>

<p>The <code>new</code> action will display the signup form and the <code>create</code>
 action is called when the form is submitted. This will validate the 
values from the form and if this passes it will redirect the browser 
back to the home page and show a message. If the validation fails the 
signup form will be redisplayed.</p>

<p>The signup form is shown below. Again, this is fairly standard. It uses <code>form_for</code> with the <code>@user</code> instance variable, has a section for displaying any errors and finally three fields for <code>email</code>, <code>password</code> and <code>password_confirmation</code>.</p>

      <div class="code_block">
        <div class="code_header">
          /app/views/users/new.html.erb
                <div id="clippy_4794357" class="clippy">
        <span style="display:none" class="clippy_code">&lt;h1&gt;Sign Up&lt;/h1&gt;

&lt;%= form_for @user do |f| %&gt;
  &lt;% if @user.errors.any? %&gt;
    &lt;div class="error_messages"&gt;
      &lt;h2&gt;Form is invalid&lt;/h2&gt;
      &lt;ul&gt;
        &lt;% @user.errors.full_messages.each do |message| %&gt;
          &lt;li&gt;&lt;%= message %&gt;&lt;/li&gt;
        &lt;% end %&gt;
      &lt;/ul&gt;
    &lt;/div&gt;
  &lt;% end %&gt;

  &lt;div class="field"&gt;
    &lt;%= f.label :email %&gt;&lt;br /&gt;
    &lt;%= f.text_field :email %&gt;
  &lt;/div&gt;
  &lt;div class="field"&gt;
    &lt;%= f.label :password %&gt;&lt;br /&gt;
    &lt;%= f.password_field :password %&gt;
  &lt;/div&gt;
  &lt;div class="field"&gt;
    &lt;%= f.label :password_confirmation %&gt;&lt;br /&gt;
    &lt;%= f.password_field :password_confirmation %&gt;
  &lt;/div&gt;
  &lt;div class="actions"&gt;&lt;%= f.submit "Sign Up" %&gt;&lt;/div&gt;
&lt;% end %&gt;</span>
        <span class="clippy_label"></span>
        <object type="application/x-shockwave-flash" data="250-authentication-from-scratch-revised_files/clippy.swf" id="clippy_4794357_flash" height="14" width="14">
        <param name="movie" value="/flash/clippy.swf">
        <param name="allowScriptAccess" value="always">
        <param name="quality" value="high">
        <param name="scale" value="noscale">
        <param name="FlashVars" value="target=%23clippy_4794357">
        <param name="bgcolor" value="#E0E0E0">
        </object>
      </div>

        </div>
        <div class="CodeRay">
  <div class="code"><pre><span class="ta">&lt;h1&gt;</span>Sign Up<span class="ta">&lt;/h1&gt;</span>

<span class="il"><span class="idl">&lt;%=</span> form_for <span class="iv">@user</span> <span class="r">do</span> |f| <span class="idl">%&gt;</span></span>
  <span class="il"><span class="idl">&lt;%</span> <span class="r">if</span> <span class="iv">@user</span>.errors.any? <span class="idl">%&gt;</span></span>
    <span class="ta">&lt;div</span> <span class="an">class</span>=<span class="s"><span class="dl">"</span><span class="k">error_messages</span><span class="dl">"</span></span><span class="ta">&gt;</span>
      <span class="ta">&lt;h2&gt;</span>Form is invalid<span class="ta">&lt;/h2&gt;</span>
      <span class="ta">&lt;ul&gt;</span>
        <span class="il"><span class="idl">&lt;%</span> <span class="iv">@user</span>.errors.full_messages.each <span class="r">do</span> |message| <span class="idl">%&gt;</span></span>
          <span class="ta">&lt;li&gt;</span><span class="il"><span class="idl">&lt;%=</span> message <span class="idl">%&gt;</span></span><span class="ta">&lt;/li&gt;</span>
        <span class="il"><span class="idl">&lt;%</span> <span class="r">end</span> <span class="idl">%&gt;</span></span>
      <span class="ta">&lt;/ul&gt;</span>
    <span class="ta">&lt;/div&gt;</span>
  <span class="il"><span class="idl">&lt;%</span> <span class="r">end</span> <span class="idl">%&gt;</span></span>

  <span class="ta">&lt;div</span> <span class="an">class</span>=<span class="s"><span class="dl">"</span><span class="k">field</span><span class="dl">"</span></span><span class="ta">&gt;</span>
    <span class="il"><span class="idl">&lt;%=</span> f.label <span class="sy">:email</span> <span class="idl">%&gt;</span></span><span class="ta">&lt;br</span> <span class="ta">/&gt;</span>
    <span class="il"><span class="idl">&lt;%=</span> f.text_field <span class="sy">:email</span> <span class="idl">%&gt;</span></span>
  <span class="ta">&lt;/div&gt;</span>
  <span class="ta">&lt;div</span> <span class="an">class</span>=<span class="s"><span class="dl">"</span><span class="k">field</span><span class="dl">"</span></span><span class="ta">&gt;</span>
    <span class="il"><span class="idl">&lt;%=</span> f.label <span class="sy">:password</span> <span class="idl">%&gt;</span></span><span class="ta">&lt;br</span> <span class="ta">/&gt;</span>
    <span class="il"><span class="idl">&lt;%=</span> f.password_field <span class="sy">:password</span> <span class="idl">%&gt;</span></span>
  <span class="ta">&lt;/div&gt;</span>
  <span class="ta">&lt;div</span> <span class="an">class</span>=<span class="s"><span class="dl">"</span><span class="k">field</span><span class="dl">"</span></span><span class="ta">&gt;</span>
    <span class="il"><span class="idl">&lt;%=</span> f.label <span class="sy">:password_confirmation</span> <span class="idl">%&gt;</span></span><span class="ta">&lt;br</span> <span class="ta">/&gt;</span>
    <span class="il"><span class="idl">&lt;%=</span> f.password_field <span class="sy">:password_confirmation</span> <span class="idl">%&gt;</span></span>
  <span class="ta">&lt;/div&gt;</span>
  <span class="ta">&lt;div</span> <span class="an">class</span>=<span class="s"><span class="dl">"</span><span class="k">actions</span><span class="dl">"</span></span><span class="ta">&gt;</span><span class="il"><span class="idl">&lt;%=</span> f.submit <span class="s"><span class="dl">"</span><span class="k">Sign Up</span><span class="dl">"</span></span> <span class="idl">%&gt;</span></span><span class="ta">&lt;/div&gt;</span>
<span class="il"><span class="idl">&lt;%</span> <span class="r">end</span> <span class="idl">%&gt;</span></span></pre></div>
</div>

      </div>

<p>Now all we need is a link to this form. We’ll put it in the application’s layout file.</p>

      <div class="code_block">
        <div class="code_header">
          /app/views/layouts/application.html.erb
                <div id="clippy_2591342" class="clippy">
        <span style="display:none" class="clippy_code">&lt;div id="user_header"&gt;
  &lt;%= link_to "Sign Up", new_user_path %&gt;
&lt;/div&gt;</span>
        <span class="clippy_label"></span>
        <object type="application/x-shockwave-flash" data="250-authentication-from-scratch-revised_files/clippy.swf" id="clippy_2591342_flash" height="14" width="14">
        <param name="movie" value="/flash/clippy.swf">
        <param name="allowScriptAccess" value="always">
        <param name="quality" value="high">
        <param name="scale" value="noscale">
        <param name="FlashVars" value="target=%23clippy_2591342">
        <param name="bgcolor" value="#E0E0E0">
        </object>
      </div>

        </div>
        <div class="CodeRay">
  <div class="code"><pre><span class="ta">&lt;div</span> <span class="an">id</span>=<span class="s"><span class="dl">"</span><span class="k">user_header</span><span class="dl">"</span></span><span class="ta">&gt;</span>
  <span class="il"><span class="idl">&lt;%=</span> link_to <span class="s"><span class="dl">"</span><span class="k">Sign Up</span><span class="dl">"</span></span>, new_user_path <span class="idl">%&gt;</span></span>
<span class="ta">&lt;/div&gt;</span></pre></div>
</div>

      </div>

<p>When we reload the home page now the “Sign Up” link is visible and clicking it will take us to our new form.</p>

<div class="imageWrapper">
  <img src="250-authentication-from-scratch-revised_files/E250RI02.png" alt="The new sign up form." height="413" width="800">
</div>

<p>If we fill in this form incorrectly we’ll see validation errors as 
we’d expect. Once we’ve filled it in successfully we’ll be redirected 
back to the home page and we’ll see a flash message that tells us we’ve 
signed up.</p>


<div class="imageWrapper">
  <img src="250-authentication-from-scratch-revised_files/E250RI03.png" alt="Signed up successfully." height="413" width="800">
</div>

<h3>Logging In And Out</h3>

<p>So far we haven’t done any actual authentication, we’ve just created a <code>User</code>
 record. For authentication we need a login form. We’ll create that now 
and also add a “Log In” link next to the “Sign Up” one. First we’ll 
create a new <code>SessionsController</code> to handle logging in and give it a <code>new</code> action.</p>

      <div class="code_block">
        <div class="code_header">
          terminal
                <div id="clippy_4762062" class="clippy">
        <span style="display:none" class="clippy_code">$ rails g controller sessions new</span>
        <span class="clippy_label"></span>
        <object type="application/x-shockwave-flash" data="250-authentication-from-scratch-revised_files/clippy.swf" id="clippy_4762062_flash" height="14" width="14">
        <param name="movie" value="/flash/clippy.swf">
        <param name="allowScriptAccess" value="always">
        <param name="quality" value="high">
        <param name="scale" value="noscale">
        <param name="FlashVars" value="target=%23clippy_4762062">
        <param name="bgcolor" value="#E0E0E0">
        </object>
      </div>

        </div>
        <div class="CodeRay">
  <div class="code"><pre>$ rails g controller sessions new</pre></div>
</div>

      </div>

<p>We’ll need to adjust the routes that were generated by this command. The <code>SessionsController</code> is a RESTful-style controller so we’ll delete the generated <code>get "sessions/new"</code> route and add a new <code>sessions</code> resource.</p>

      <div class="code_block">
        <div class="code_header">
          /config/routes.rb
                <div id="clippy_9621992" class="clippy">
        <span style="display:none" class="clippy_code">Blog::Application.routes.draw do
  
  resources :sessions
  resources :users

  root to: 'articles#index'
  resources :articles
end</span>
        <span class="clippy_label"></span>
        <object type="application/x-shockwave-flash" data="250-authentication-from-scratch-revised_files/clippy.swf" id="clippy_9621992_flash" height="14" width="14">
        <param name="movie" value="/flash/clippy.swf">
        <param name="allowScriptAccess" value="always">
        <param name="quality" value="high">
        <param name="scale" value="noscale">
        <param name="FlashVars" value="target=%23clippy_9621992">
        <param name="bgcolor" value="#E0E0E0">
        </object>
      </div>

        </div>
        <div class="CodeRay">
  <div class="code"><pre><span class="co">Blog</span>::<span class="co">Application</span>.routes.draw <span class="r">do</span>
  
  resources <span class="sy">:sessions</span>
  resources <span class="sy">:users</span>

  root <span class="sy">to:</span> <span class="s"><span class="dl">'</span><span class="k">articles#index</span><span class="dl">'</span></span>
  resources <span class="sy">:articles</span>
<span class="r">end</span></pre></div>
</div>

      </div>

<p>We can leave the new action blank in the controller but we will 
modify the associated view as this is where the login form will go.</p>

      <div class="code_block">
        <div class="code_header">
          /app/views/sessions/new.html.erb
                <div id="clippy_9425403" class="clippy">
        <span style="display:none" class="clippy_code">&lt;h1&gt;Log In&lt;/h1&gt;

&lt;%= form_tag sessions_path do %&gt;
  &lt;div class="field"&gt;
	  &lt;%= label_tag :email %&gt;&lt;br /&gt;
	  &lt;%= text_field_tag :email, params[:email] %&gt;
  &lt;/div&gt;
  &lt;div class="field"&gt;
	  &lt;%= label_tag :password %&gt;&lt;br /&gt;
	  &lt;%= password_field_tag :password %&gt;
  &lt;/div&gt;
  &lt;div class="actions"&gt;&lt;%= submit_tag "Log In" %&gt;
&lt;% end %&gt;</span>
        <span class="clippy_label"></span>
        <object type="application/x-shockwave-flash" data="250-authentication-from-scratch-revised_files/clippy.swf" id="clippy_9425403_flash" height="14" width="14">
        <param name="movie" value="/flash/clippy.swf">
        <param name="allowScriptAccess" value="always">
        <param name="quality" value="high">
        <param name="scale" value="noscale">
        <param name="FlashVars" value="target=%23clippy_9425403">
        <param name="bgcolor" value="#E0E0E0">
        </object>
      </div>

        </div>
        <div class="CodeRay">
  <div class="code"><pre><span class="ta">&lt;h1&gt;</span>Log In<span class="ta">&lt;/h1&gt;</span>

<span class="il"><span class="idl">&lt;%=</span> form_tag sessions_path <span class="r">do</span> <span class="idl">%&gt;</span></span>
  <span class="ta">&lt;div</span> <span class="an">class</span>=<span class="s"><span class="dl">"</span><span class="k">field</span><span class="dl">"</span></span><span class="ta">&gt;</span>
          <span class="il"><span class="idl">&lt;%=</span> label_tag <span class="sy">:email</span> <span class="idl">%&gt;</span></span><span class="ta">&lt;br</span> <span class="ta">/&gt;</span>
          <span class="il"><span class="idl">&lt;%=</span> text_field_tag <span class="sy">:email</span>, params[<span class="sy">:email</span>] <span class="idl">%&gt;</span></span>
  <span class="ta">&lt;/div&gt;</span>
  <span class="ta">&lt;div</span> <span class="an">class</span>=<span class="s"><span class="dl">"</span><span class="k">field</span><span class="dl">"</span></span><span class="ta">&gt;</span>
          <span class="il"><span class="idl">&lt;%=</span> label_tag <span class="sy">:password</span> <span class="idl">%&gt;</span></span><span class="ta">&lt;br</span> <span class="ta">/&gt;</span>
          <span class="il"><span class="idl">&lt;%=</span> password_field_tag <span class="sy">:password</span> <span class="idl">%&gt;</span></span>
  <span class="ta">&lt;/div&gt;</span>
  <span class="ta">&lt;div</span> <span class="an">class</span>=<span class="s"><span class="dl">"</span><span class="k">actions</span><span class="dl">"</span></span><span class="ta">&gt;</span><span class="il"><span class="idl">&lt;%=</span> submit_tag <span class="s"><span class="dl">"</span><span class="k">Log In</span><span class="dl">"</span></span> <span class="idl">%&gt;</span></span>
<span class="il"><span class="idl">&lt;%</span> <span class="r">end</span> <span class="idl">%&gt;</span></span></pre></div>
</div>

      </div>

<p>As our <code>SessionsController</code> doesn’t have a model behind it we use <code>form_tag</code> for this form. It POSTs to the <code>sessions_path</code> which will trigger the <code>SessionsController</code>’s <code>create</code> action and we’ll write that action next.</p>

      <div class="code_block">
        <div class="code_header">
          /app/controllers/sessions_controller.rb
                <div id="clippy_3184509" class="clippy">
        <span style="display:none" class="clippy_code">def create
  user = User.find_by_email(params[:email])
  if user &amp;&amp; user.authenticate(params[:password])
    session[:user_id] = user.id
    redirect_to root_url, notice: "Logged in!"
  else
    flash.now.alert = "Email or password is invalid."
  end
end</span>
        <span class="clippy_label"></span>
        <object type="application/x-shockwave-flash" data="250-authentication-from-scratch-revised_files/clippy.swf" id="clippy_3184509_flash" height="14" width="14">
        <param name="movie" value="/flash/clippy.swf">
        <param name="allowScriptAccess" value="always">
        <param name="quality" value="high">
        <param name="scale" value="noscale">
        <param name="FlashVars" value="target=%23clippy_3184509">
        <param name="bgcolor" value="#E0E0E0">
        </object>
      </div>

        </div>
        <div class="CodeRay">
  <div class="code"><pre><span class="r">def</span> <span class="fu">create</span>
  user = <span class="co">User</span>.find_by_email(params[<span class="sy">:email</span>])
  <span class="r">if</span> user &amp;&amp; user.authenticate(params[<span class="sy">:password</span>])
    session[<span class="sy">:user_id</span>] = user.id
    redirect_to root_url, <span class="sy">notice:</span> <span class="s"><span class="dl">"</span><span class="k">Logged in!</span><span class="dl">"</span></span>
  <span class="r">else</span>
    flash.now.alert = <span class="s"><span class="dl">"</span><span class="k">Email or password is invalid.</span><span class="dl">"</span></span>
  <span class="r">end</span>
<span class="r">end</span></pre></div>
</div>

      </div>

<p>When the form is submitted we try to find a user by the email address that was entered on the form. If we find one we use <code>authenticate</code> to check that the entered password is correct. This is a method that <code>has_secure_password</code> provides and will return a boolean value. If the password matches we store the user’s <code>id</code>
 in a session variable and redirect to the home page. If either the 
username or password are incorrect the form is shown again with an error
 message. We use <code>flash.now</code> here as we need the message to be displayed immediately, not after a redirect.</p>

<p>To finish this feature we just need to add a link next to the “Sign Up” link.</p>

      <div class="code_block">
        <div class="code_header">
          /app/views/layouts/application.html.erb
                <div id="clippy_1577679" class="clippy">
        <span style="display:none" class="clippy_code">&lt;div id="user_header"&gt;
  &lt;%= link_to "Sign Up", new_user_path %&gt; or
  &lt;%= link_to "Log In", new_session_path %&gt;
&lt;/div&gt;</span>
        <span class="clippy_label"></span>
        <object type="application/x-shockwave-flash" data="250-authentication-from-scratch-revised_files/clippy.swf" id="clippy_1577679_flash" height="14" width="14">
        <param name="movie" value="/flash/clippy.swf">
        <param name="allowScriptAccess" value="always">
        <param name="quality" value="high">
        <param name="scale" value="noscale">
        <param name="FlashVars" value="target=%23clippy_1577679">
        <param name="bgcolor" value="#E0E0E0">
        </object>
      </div>

        </div>
        <div class="CodeRay">
  <div class="code"><pre><span class="ta">&lt;div</span> <span class="an">id</span>=<span class="s"><span class="dl">"</span><span class="k">user_header</span><span class="dl">"</span></span><span class="ta">&gt;</span>
  <span class="il"><span class="idl">&lt;%=</span> link_to <span class="s"><span class="dl">"</span><span class="k">Sign Up</span><span class="dl">"</span></span>, new_user_path <span class="idl">%&gt;</span></span> or
  <span class="il"><span class="idl">&lt;%=</span> link_to <span class="s"><span class="dl">"</span><span class="k">Log In</span><span class="dl">"</span></span>, new_session_path <span class="idl">%&gt;</span></span>
<span class="ta">&lt;/div&gt;</span></pre></div>
</div>

      </div>

<p>If we reload the home page now we’ll see the new “Log In” link and if
 we click it we’ll be taken to our new form. If we use the email address
 and password we entered when we signed up we’ll be able to log in to 
the site.</p>

<div class="imageWrapper">
  <img src="250-authentication-from-scratch-revised_files/E250RI04.png" alt="Logged in." height="413" width="800">
</div>

<p>Even though we’ve logged into the site now the “Log In” link still 
shows. It would be better if this changed to show that the user is 
currently logged in. To do this we need a way to fetch the currently 
logged-in user record and we’ll do this in the <code>ApplicationController</code> so that it’s available in all controllers.</p> 

      <div class="code_block">
        <div class="code_header">
          /app/controllers/application_controller.rb
                <div id="clippy_1579249" class="clippy">
        <span style="display:none" class="clippy_code">class ApplicationController &lt; ActionController::Base
  protect_from_forgery
  
  private
  def current_user
    @current_user ||= User.find(session[:user_id]) if session[:user_id]
  end
  helper_method :current_user
end</span>
        <span class="clippy_label"></span>
        <object type="application/x-shockwave-flash" data="250-authentication-from-scratch-revised_files/clippy.swf" id="clippy_1579249_flash" height="14" width="14">
        <param name="movie" value="/flash/clippy.swf">
        <param name="allowScriptAccess" value="always">
        <param name="quality" value="high">
        <param name="scale" value="noscale">
        <param name="FlashVars" value="target=%23clippy_1579249">
        <param name="bgcolor" value="#E0E0E0">
        </object>
      </div>

        </div>
        <div class="CodeRay">
  <div class="code"><pre><span class="r">class</span> <span class="cl">ApplicationController</span> &lt; <span class="co">ActionController</span>::<span class="co">Base</span>
  protect_from_forgery
  
  private
  <span class="r">def</span> <span class="fu">current_user</span>
    <span class="iv">@current_user</span> ||= <span class="co">User</span>.find(session[<span class="sy">:user_id</span>]) <span class="r">if</span> session[<span class="sy">:user_id</span>]
  <span class="r">end</span>
  helper_method <span class="sy">:current_user</span>
<span class="r">end</span></pre></div>
</div>

      </div>

<p>This current user will look for a <code>User</code> based on the session’s user <code>id</code>
 that was stored when they logged in, if that session variable exists. 
This method will probably be called many times per request and so it’s a
 good idea to cache it in an instance variable as we have done here. 
We’re going to need to access this method in the views, too, so we’ve 
used <code>helper_method</code> to make it a helper method. We can use 
this now to change the “Sign Up” and “Log In” links when the user is 
logged in and display a message telling the user that they’re logged in 
and showing their email address.</p>

      <div class="code_block">
        <div class="code_header">
          /app/views/layouts/application.html.erb
                <div id="clippy_660933" class="clippy">
        <span style="display:none" class="clippy_code">&lt;div id="user_header"&gt;
  &lt;% if current_user %&gt;
    Logged in as &lt;%= current_user.email %&gt;.
  &lt;% else %&gt;
    &lt;%= link_to "Sign Up", new_user_path %&gt; or
    &lt;%= link_to "Log In", new_session_path %&gt;
   &lt;% end %&gt;
&lt;/div&gt;</span>
        <span class="clippy_label"></span>
        <object type="application/x-shockwave-flash" data="250-authentication-from-scratch-revised_files/clippy.swf" id="clippy_660933_flash" height="14" width="14">
        <param name="movie" value="/flash/clippy.swf">
        <param name="allowScriptAccess" value="always">
        <param name="quality" value="high">
        <param name="scale" value="noscale">
        <param name="FlashVars" value="target=%23clippy_660933">
        <param name="bgcolor" value="#E0E0E0">
        </object>
      </div>

        </div>
        <div class="CodeRay">
  <div class="code"><pre><span class="ta">&lt;div</span> <span class="an">id</span>=<span class="s"><span class="dl">"</span><span class="k">user_header</span><span class="dl">"</span></span><span class="ta">&gt;</span>
  <span class="il"><span class="idl">&lt;%</span> <span class="r">if</span> current_user <span class="idl">%&gt;</span></span>
    Logged in as <span class="il"><span class="idl">&lt;%=</span> current_user.email <span class="idl">%&gt;</span></span>.
  <span class="il"><span class="idl">&lt;%</span> <span class="r">else</span> <span class="idl">%&gt;</span></span>
    <span class="il"><span class="idl">&lt;%=</span> link_to <span class="s"><span class="dl">"</span><span class="k">Sign Up</span><span class="dl">"</span></span>, new_user_path <span class="idl">%&gt;</span></span> or
    <span class="il"><span class="idl">&lt;%=</span> link_to <span class="s"><span class="dl">"</span><span class="k">Log In</span><span class="dl">"</span></span>, new_session_path <span class="idl">%&gt;</span></span>
   <span class="il"><span class="idl">&lt;%</span> <span class="r">end</span> <span class="idl">%&gt;</span></span>
<span class="ta">&lt;/div&gt;</span></pre></div>
</div>

      </div>

<p>As we’re logged in reloading the page now will display the email 
address we signed up with. If your authentication setup uses usernames 
instead you could display that here just as easily.</p>


<div class="imageWrapper">
  <img src="250-authentication-from-scratch-revised_files/E250RI05.png" alt="We now see a status message when we're logged in." height="413" width="800">
</div>

<h3>Logging Out</h3>

<p>While we can log in now there’s no way to log out. We need a new link
 that shows when we’re signed in and we’ll need a new action in the <code>SessionsController</code> to handle that behaviour.</p> 

      <div class="code_block">
        <div class="code_header">
          /app/controllers/sessions_controller.rb
                <div id="clippy_9938151" class="clippy">
        <span style="display:none" class="clippy_code">def destroy
  session[:user_id] = nil
  redirect_to root_url, notice: "Logged out!"
end</span>
        <span class="clippy_label"></span>
        <object type="application/x-shockwave-flash" data="250-authentication-from-scratch-revised_files/clippy.swf" id="clippy_9938151_flash" height="14" width="14">
        <param name="movie" value="/flash/clippy.swf">
        <param name="allowScriptAccess" value="always">
        <param name="quality" value="high">
        <param name="scale" value="noscale">
        <param name="FlashVars" value="target=%23clippy_9938151">
        <param name="bgcolor" value="#E0E0E0">
        </object>
      </div>

        </div>
        <div class="CodeRay">
  <div class="code"><pre><span class="r">def</span> <span class="fu">destroy</span>
  session[<span class="sy">:user_id</span>] = <span class="pc">nil</span>
  redirect_to root_url, <span class="sy">notice:</span> <span class="s"><span class="dl">"</span><span class="k">Logged out!</span><span class="dl">"</span></span>
<span class="r">end</span></pre></div>
</div>

      </div>

<p>This action is pretty simple. We just clear out the <code>user_id</code> session variable and redirect back to the home page. We could clear the entire session by calling <code>reset_session</code> instead, but clearing the <code>user_id</code> is enough to sign the user out. Now in the layout file we can add a “Log Out” link. Pointing it to the <code>destroy</code> action can be a little bit tricky because the <code>session_path</code> helper method expects an <code>id</code>
 to be passed in. We’ll just pass “current” in but we could pass in 
anything as the controller doesn’t read this parameter. We also need to 
set the <code>method</code> to <code>delete</code> so that the destroy action is triggered.</p>

      <div class="code_block">
        <div class="code_header">
          /app/views/layouts/application.html.erb
                <div id="clippy_5995773" class="clippy">
        <span style="display:none" class="clippy_code">&lt;div id="user_header"&gt;
  &lt;% if current_user %&gt;
    Logged in as &lt;%= current_user.email %&gt;.
    &lt;%= link_to "Log Out", session_path("current"), method: "delete" %&gt;
  &lt;% else %&gt;
    &lt;%= link_to "Sign Up", new_user_path %&gt; or
    &lt;%= link_to "Log In", new_session_path %&gt;
  &lt;% end %&gt;
&lt;/div&gt;</span>
        <span class="clippy_label"></span>
        <object type="application/x-shockwave-flash" data="250-authentication-from-scratch-revised_files/clippy.swf" id="clippy_5995773_flash" height="14" width="14">
        <param name="movie" value="/flash/clippy.swf">
        <param name="allowScriptAccess" value="always">
        <param name="quality" value="high">
        <param name="scale" value="noscale">
        <param name="FlashVars" value="target=%23clippy_5995773">
        <param name="bgcolor" value="#E0E0E0">
        </object>
      </div>

        </div>
        <div class="CodeRay">
  <div class="code"><pre><span class="ta">&lt;div</span> <span class="an">id</span>=<span class="s"><span class="dl">"</span><span class="k">user_header</span><span class="dl">"</span></span><span class="ta">&gt;</span>
  <span class="il"><span class="idl">&lt;%</span> <span class="r">if</span> current_user <span class="idl">%&gt;</span></span>
    Logged in as <span class="il"><span class="idl">&lt;%=</span> current_user.email <span class="idl">%&gt;</span></span>.
    <span class="il"><span class="idl">&lt;%=</span> link_to <span class="s"><span class="dl">"</span><span class="k">Log Out</span><span class="dl">"</span></span>, session_path(<span class="s"><span class="dl">"</span><span class="k">current</span><span class="dl">"</span></span>), <span class="sy">method:</span> <span class="s"><span class="dl">"</span><span class="k">delete</span><span class="dl">"</span></span> <span class="idl">%&gt;</span></span>
  <span class="il"><span class="idl">&lt;%</span> <span class="r">else</span> <span class="idl">%&gt;</span></span>
    <span class="il"><span class="idl">&lt;%=</span> link_to <span class="s"><span class="dl">"</span><span class="k">Sign Up</span><span class="dl">"</span></span>, new_user_path <span class="idl">%&gt;</span></span> or
    <span class="il"><span class="idl">&lt;%=</span> link_to <span class="s"><span class="dl">"</span><span class="k">Log In</span><span class="dl">"</span></span>, new_session_path <span class="idl">%&gt;</span></span>
  <span class="il"><span class="idl">&lt;%</span> <span class="r">end</span> <span class="idl">%&gt;</span></span>
<span class="ta">&lt;/div&gt;</span></pre></div>
</div>

      </div>

<p>Reloading the page will now show us the “Log Out” link and when we click it we’ll be logged out.</p>

<div class="imageWrapper">
  <img src="250-authentication-from-scratch-revised_files/E250RI06.png" alt="The log out link now works." height="413" width="800">
</div>

<h3>Better Routes</h3>

<p>We could make the “Sign Up” and “Log In” URLs a little prettier. The login form is currently at <code>/sessions/new</code> but it would better to have <code>/login</code> point to this. We can add a three custom routes to improve the URLs for signing in and logging in and out.</p>

      <div class="code_block">
        <div class="code_header">
          /config/routes.rb
                <div id="clippy_3918359" class="clippy">
        <span style="display:none" class="clippy_code">Blog::Application.routes.draw do
  
  get 'signup', to: 'users#new', as: 'signup'
  get 'login', to: 'sessions#new', as: 'login'
  get 'logout', to: 'sessions#destroy', as: 'logout'
  
  resources :sessions
  resources :users

  root to: 'articles#index'
  resources :articles
end</span>
        <span class="clippy_label"></span>
        <object type="application/x-shockwave-flash" data="250-authentication-from-scratch-revised_files/clippy.swf" id="clippy_3918359_flash" height="14" width="14">
        <param name="movie" value="/flash/clippy.swf">
        <param name="allowScriptAccess" value="always">
        <param name="quality" value="high">
        <param name="scale" value="noscale">
        <param name="FlashVars" value="target=%23clippy_3918359">
        <param name="bgcolor" value="#E0E0E0">
        </object>
      </div>

        </div>
        <div class="CodeRay">
  <div class="code"><pre><span class="co">Blog</span>::<span class="co">Application</span>.routes.draw <span class="r">do</span>
  
  get <span class="s"><span class="dl">'</span><span class="k">signup</span><span class="dl">'</span></span>, <span class="sy">to:</span> <span class="s"><span class="dl">'</span><span class="k">users#new</span><span class="dl">'</span></span>, <span class="sy">as:</span> <span class="s"><span class="dl">'</span><span class="k">signup</span><span class="dl">'</span></span>
  get <span class="s"><span class="dl">'</span><span class="k">login</span><span class="dl">'</span></span>, <span class="sy">to:</span> <span class="s"><span class="dl">'</span><span class="k">sessions#new</span><span class="dl">'</span></span>, <span class="sy">as:</span> <span class="s"><span class="dl">'</span><span class="k">login</span><span class="dl">'</span></span>
  get <span class="s"><span class="dl">'</span><span class="k">logout</span><span class="dl">'</span></span>, <span class="sy">to:</span> <span class="s"><span class="dl">'</span><span class="k">sessions#destroy</span><span class="dl">'</span></span>, <span class="sy">as:</span> <span class="s"><span class="dl">'</span><span class="k">logout</span><span class="dl">'</span></span>
  
  resources <span class="sy">:sessions</span>
  resources <span class="sy">:users</span>

  root <span class="sy">to:</span> <span class="s"><span class="dl">'</span><span class="k">articles#index</span><span class="dl">'</span></span>
  resources <span class="sy">:articles</span>
<span class="r">end</span></pre></div>
</div>

      </div>

<p>One thing to note about the <code>logout</code> path is that we’re using <code>get</code>. We might consider using <code>delete</code> instead as technically this action does change user state but as it doesn’t do any permanent damage we’ll leave this as <code>get</code> here. Now we can update our layout file to use these new routes.</p> 

      <div class="code_block">
        <div class="code_header">
          /app/views/layouts/application.html.erb
                <div id="clippy_9752510" class="clippy">
        <span style="display:none" class="clippy_code">&lt;div id="container"&gt;
  &lt;div id="user_header"&gt;
    &lt;% if current_user %&gt;
      Logged in as &lt;%= current_user.email %&gt;.
      &lt;%= link_to "Log Out", logout_path %&gt;
    &lt;% else %&gt;
      &lt;%= link_to "Sign Up", signup_path %&gt; or
      &lt;%= link_to "Log In", login_path %&gt;
    &lt;% end %&gt;
&lt;/div&gt;</span>
        <span class="clippy_label"></span>
        <object type="application/x-shockwave-flash" data="250-authentication-from-scratch-revised_files/clippy.swf" id="clippy_9752510_flash" height="14" width="14">
        <param name="movie" value="/flash/clippy.swf">
        <param name="allowScriptAccess" value="always">
        <param name="quality" value="high">
        <param name="scale" value="noscale">
        <param name="FlashVars" value="target=%23clippy_9752510">
        <param name="bgcolor" value="#E0E0E0">
        </object>
      </div>

        </div>
        <div class="CodeRay">
  <div class="code"><pre><span class="ta">&lt;div</span> <span class="an">id</span>=<span class="s"><span class="dl">"</span><span class="k">container</span><span class="dl">"</span></span><span class="ta">&gt;</span>
  <span class="ta">&lt;div</span> <span class="an">id</span>=<span class="s"><span class="dl">"</span><span class="k">user_header</span><span class="dl">"</span></span><span class="ta">&gt;</span>
    <span class="il"><span class="idl">&lt;%</span> <span class="r">if</span> current_user <span class="idl">%&gt;</span></span>
      Logged in as <span class="il"><span class="idl">&lt;%=</span> current_user.email <span class="idl">%&gt;</span></span>.
      <span class="il"><span class="idl">&lt;%=</span> link_to <span class="s"><span class="dl">"</span><span class="k">Log Out</span><span class="dl">"</span></span>, logout_path <span class="idl">%&gt;</span></span>
    <span class="il"><span class="idl">&lt;%</span> <span class="r">else</span> <span class="idl">%&gt;</span></span>
      <span class="il"><span class="idl">&lt;%=</span> link_to <span class="s"><span class="dl">"</span><span class="k">Sign Up</span><span class="dl">"</span></span>, signup_path <span class="idl">%&gt;</span></span> or
      <span class="il"><span class="idl">&lt;%=</span> link_to <span class="s"><span class="dl">"</span><span class="k">Log In</span><span class="dl">"</span></span>, login_path <span class="idl">%&gt;</span></span>
    <span class="il"><span class="idl">&lt;%</span> <span class="r">end</span> <span class="idl">%&gt;</span></span>
<span class="ta">&lt;/div&gt;</span></pre></div>
</div>

      </div>

<h3>Automatically Logging In New Users</h3>

<p>One loose end that we’ve left untied is that when the user signs up 
they aren’t automatically logged in. The user record is created but the 
new user has to enter their details again to sign in. This is easy to 
fix by modifying the <code>UsersController</code>’s <code>create</code> action and setting the <code>user_id</code> session variable when the new user is saved.</p> 

      <div class="code_block">
        <div class="code_header">
          /app/controllers/users_controller.rb
                <div id="clippy_6529554" class="clippy">
        <span style="display:none" class="clippy_code">def create
  @user = User.new(params[:user])
  if @user.save
    session[:user_id] = @user.id
    redirect_to root_url, notice: "Thank you for signing up!"
  else
    render "new"
  end
end</span>
        <span class="clippy_label"></span>
        <object type="application/x-shockwave-flash" data="250-authentication-from-scratch-revised_files/clippy.swf" id="clippy_6529554_flash" height="14" width="14">
        <param name="movie" value="/flash/clippy.swf">
        <param name="allowScriptAccess" value="always">
        <param name="quality" value="high">
        <param name="scale" value="noscale">
        <param name="FlashVars" value="target=%23clippy_6529554">
        <param name="bgcolor" value="#E0E0E0">
        </object>
      </div>

        </div>
        <div class="CodeRay">
  <div class="code"><pre><span class="r">def</span> <span class="fu">create</span>
  <span class="iv">@user</span> = <span class="co">User</span>.new(params[<span class="sy">:user</span>])
  <span class="r">if</span> <span class="iv">@user</span>.save
    session[<span class="sy">:user_id</span>] = <span class="iv">@user</span>.id
    redirect_to root_url, <span class="sy">notice:</span> <span class="s"><span class="dl">"</span><span class="k">Thank you for signing up!</span><span class="dl">"</span></span>
  <span class="r">else</span>
    render <span class="s"><span class="dl">"</span><span class="k">new</span><span class="dl">"</span></span>
  <span class="r">end</span>
<span class="r">end</span></pre></div>
</div>

      </div>

<p>If we find that there’s duplication in the logic between the <code>SessionsController</code>’s
 logging in behaviour and this behaviour we can abstract this out into 
some kind of controller method which can be shared between them. Here 
it’s OK to have this small amount of duplication. If we sign up as a new
 user now we’ll be signed in straight away.</p>

<div class="imageWrapper">
  <img src="250-authentication-from-scratch-revised_files/E250RI07.png" alt="We’re now signed in straightaway." height="413" width="800">
</div>

<h3>Basic Authorization</h3>

<p>A common requirement when dealing with authentication is to make sure
 that they’re logged in before giving them access to a specific page. 
Our application shows a number of articles and each article’s page has 
an “Edit” link which takes us to a page where we can edit that article. 
We want our application to only allow logged-in users to edit articles. 
Since this is such common behaviour we’ll define it in the <code>ApplicationController</code> so that we can use it anywhere.</p> 

      <div class="code_block">
        <div class="code_header">
          /app/controllers/application_controller.rb
                <div id="clippy_4431399" class="clippy">
        <span style="display:none" class="clippy_code">def authorize
  redirect_to login_url, alert: "Not authorized" if current_user.nil?
end</span>
        <span class="clippy_label"></span>
        <object type="application/x-shockwave-flash" data="250-authentication-from-scratch-revised_files/clippy.swf" id="clippy_4431399_flash" height="14" width="14">
        <param name="movie" value="/flash/clippy.swf">
        <param name="allowScriptAccess" value="always">
        <param name="quality" value="high">
        <param name="scale" value="noscale">
        <param name="FlashVars" value="target=%23clippy_4431399">
        <param name="bgcolor" value="#E0E0E0">
        </object>
      </div>

        </div>
        <div class="CodeRay">
  <div class="code"><pre><span class="r">def</span> <span class="fu">authorize</span>
  redirect_to login_url, <span class="sy">alert:</span> <span class="s"><span class="dl">"</span><span class="k">Not authorized</span><span class="dl">"</span></span> <span class="r">if</span> current_user.nil?
<span class="r">end</span></pre></div>
</div>

      </div>

<p>This method will check for a current user and redirect to the login 
page if it fails to find one with an alert telling them that they aren’t
 authorized. We can now use this method as a <code>before_filter</code> on any controller action we want to protect, such as the <code>ArticlesController</code>’s <code>edit</code> and <code>update</code> actions.</p>

      <div class="code_block">
        <div class="code_header">
          /app/controllers/articles_controller.rb
                <div id="clippy_8766616" class="clippy">
        <span style="display:none" class="clippy_code">class ArticlesController &lt; ApplicationController
  
  before_filter :authorize, only: [:edit, :update]
  
  def index
    @articles = Article.all
  end

  def show
    @article = Article.find(params[:id])
  end

  def edit
    @article = Article.find(params[:id])
  end

  def update
    @article = Article.find(params[:id])
    if @article.update_attributes(params[:article])
      redirect_to @article, notice: "Article has been updated."
    else
      render "edit"
    end
  end
end</span>
        <span class="clippy_label"></span>
        <object type="application/x-shockwave-flash" data="250-authentication-from-scratch-revised_files/clippy.swf" id="clippy_8766616_flash" height="14" width="14">
        <param name="movie" value="/flash/clippy.swf">
        <param name="allowScriptAccess" value="always">
        <param name="quality" value="high">
        <param name="scale" value="noscale">
        <param name="FlashVars" value="target=%23clippy_8766616">
        <param name="bgcolor" value="#E0E0E0">
        </object>
      </div>

        </div>
        <div class="CodeRay">
  <div class="code"><pre><span class="r">class</span> <span class="cl">ArticlesController</span> &lt; <span class="co">ApplicationController</span>
  
  before_filter <span class="sy">:authorize</span>, <span class="sy">only:</span> [<span class="sy">:edit</span>, <span class="sy">:update</span>]
  
  <span class="r">def</span> <span class="fu">index</span>
    <span class="iv">@articles</span> = <span class="co">Article</span>.all
  <span class="r">end</span>

  <span class="r">def</span> <span class="fu">show</span>
    <span class="iv">@article</span> = <span class="co">Article</span>.find(params[<span class="sy">:id</span>])
  <span class="r">end</span>

  <span class="r">def</span> <span class="fu">edit</span>
    <span class="iv">@article</span> = <span class="co">Article</span>.find(params[<span class="sy">:id</span>])
  <span class="r">end</span>

  <span class="r">def</span> <span class="fu">update</span>
    <span class="iv">@article</span> = <span class="co">Article</span>.find(params[<span class="sy">:id</span>])
    <span class="r">if</span> <span class="iv">@article</span>.update_attributes(params[<span class="sy">:article</span>])
      redirect_to <span class="iv">@article</span>, <span class="sy">notice:</span> <span class="s"><span class="dl">"</span><span class="k">Article has been updated.</span><span class="dl">"</span></span>
    <span class="r">else</span>
      render <span class="s"><span class="dl">"</span><span class="k">edit</span><span class="dl">"</span></span>
    <span class="r">end</span>
  <span class="r">end</span>
<span class="r">end</span></pre></div>
</div>

      </div>

<p>We can still edit an article now when we’re logged in but if we log out and try again we’ll be redirected.</p>

<div class="imageWrapper">
  <img src="250-authentication-from-scratch-revised_files/E250RI08.png" alt="We’re now redirected if we visit a page we're not authorized to view." height="413" width="800">
</div> 

<p>You could improve this user experience depending on how your 
application works, but the basic functionality is here. If you have more
 complex authorization logic than this you could use a gem like <a href="https://github.com/ryanb/cancan">CanCan</a> to help with this.</p> 

<p>Now we have a complete authentication solution built from scratch and
 there are a variety of ways we could add on to this. For example in 
UsersController we might want a profile page or a way to update a user’s
 information. We could do this easily by adding show or edit actions to 
this controller. If we want to store the user’s login in a permanent 
cookie instead of a temporary session take a look at <a href="http://railscasts.com/episodes/274-remember-me-reset-password">episode 274</a> which shows how to add “Remember Me” functionality and also a way for users to reset their password.</p>
  </div>
</div>
</div>
    </div>
    <div id="footer">
      <div class="inner">
        ©2012 RailsCasts - <a href="http://railscasts.com/privacy">Privacy Policy</a> - Hosted by <a href="http://www.linode.com/?utm_source=railscasts.com&amp;utm_medium=Badge&amp;utm_campaign=Railscasts">Linode</a>
      </div>
    </div>

      <!-- Google Analytics -->
      <script type="text/javascript">
  var gaJsHost = (("https:" == document.location.protocol) ? "https://ssl." : "http://www.");
  document.write(unescape("%3Cscript src='" + gaJsHost + "google-analytics.com/ga.js' type='text/javascript'%3E%3C/script%3E"));
  </script><script src="250-authentication-from-scratch-revised_files/ga.js" type="text/javascript"></script>
  <script type="text/javascript">
  try {
  var pageTracker = _gat._getTracker("UA-7696481-1");
  pageTracker._trackPageview();
  } catch(err) {}</script>
  

<style>#sv #sublime_videos{position:static!important}#sv #sublime_videos,#sv #sublime_zoom{padding:0!important;margin:0!important;overflow:visible!important}#sv .sublime_video_wrapper{display:block;position:relative!important;line-height:0!important;background:#000!important;overflow:hidden!important;direction:ltr!important;padding:0!important;text-align:center!important;-webkit-user-select:none!important;-moz-user-select:none!important}#sv .sublime_video_wrapper *,#sv #sz_content_wrapper,#sv #sv_contextual_menu *{padding:0!important;margin:0!important;border:none!important;overflow:visible!important;position:static!important;background:none!important;float:none!important;z-index:auto!important}#sv #sublime_videos,#sv #sublime_zoom,#sv .sublime_video_wrapper,#sv .sublime_video_wrapper *,#sv_contextual_menu,#sv_contextual_menu *{-moz-box-sizing:content-box!important;-webkit-box-sizing:content-box!important;-ms-box-sizing:content-box!important;box-sizing:content-box!important}#sv .sublime_video_content{height:100%!important}#sv .sublime_video_wrapper img{position:absolute!important;top:0!important;left:0!important;bottom:auto!important;right:auto!important;max-width:none!important;-moz-border-radius:0!important;-webkit-border-radius:0!important;border-radius:0!important}#sv .sublime_video_wrapper span.sv_play_button{display:block;position:absolute!important;width:auto!important;height:auto!important;top:0!important;bottom:0!important;left:0!important;right:0!important;cursor:pointer!important;opacity:1!important;background-color:rgba(0,0,0,0.3)!important;background-position:50%!important;background-repeat:no-repeat!important;-webkit-transition:.5s background-color!important;-moz-transition:.5s background-color!important;-o-transition:.5s background-color!important}#sv .sublime_video_wrapper span.sv_play_button:hover{background-color:rgba(0,0,0,0)!important}#sv .sublime_video_wrapper span.sv_play_button.ie{width:100%!important;height:100%!important;line-height:0!important;background:url(http://cdn.sublimevideo.net/p/ie/transparent_pixel.gif)!important;cursor:pointer!important;filter:progid:DXImageTransform.Microsoft.gradient(startColorstr=#4C000000,endColorstr=#4C000000)!important;zoom:1!important}#sv .sublime_video_wrapper span.sv_play_button.ie:hover{filter:none!important}#sv .sublime_video_wrapper span.sv_play_button.ie span{display:block;width:78px!important;height:78px!important;margin:-39px auto 0!important;position:relative!important;top:50%!important;cursor:pointer!important}#sv .sublime_video_wrapper .sv_error_messages{-webkit-user-select:auto;-moz-user-select:auto;user-select:auto}#sv .sublime_video_wrapper .sv_error_messages .sv_content td p a{color:#ccc!important;text-shadow:none!important;display:inline!important;padding:0!important;margin:0!important}#sv #sv_contextual_menu{margin:0!important;padding:6px 0 0 9px!important;border:none!important;background:url("data:image/png;charset=utf-8;base64,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") no-repeat!important;*background:none!important;width:126px!important;height:70px!important;position:absolute!important;bottom:auto!important;right:auto!important;z-index:999999!important}#sv #sv_contextual_menu_ie_bg{width:126px!important;height:70px!important;position:absolute!important;top:0!important;left:0!important;background:none!important;filter:progid:DXImageTransform.Microsoft.AlphaImageLoader(src="http://cdn.sublimevideo.net/p/ie/contextual_background.png")!important}#sv #sv_contextual_menu.no_brand{height:50px!important;background:url("data:image/png;charset=utf-8;base64,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") no-repeat!important}#sv #sv_contextual_menu_ie_bg.no_brand{height:50px!important;filter:progid:DXImageTransform.Microsoft.AlphaImageLoader(src="http://cdn.sublimevideo.net/p/ie/contextual_background_no_brand.png")!important}#sv #sv_contextual_menu span.logo{width:108px!important;height:24px!important;display:block!important;background:none!important;border:none!important;outline:none!important;padding:0!important;margin:0!important;position:static!important;cursor:pointer!important}#sv #sv_contextual_menu_transparent_layer{position:fixed!important;background:transparent!important;top:0!important;left:0!important;z-index:999998!important;width:100%!important;height:100%!important}#sv #sv_mode_switch{width:94px!important;height:18px!important;background:none!important;position:absolute!important;bottom:25px!important;left:16px!important;overflow:hidden!important}#sv #sv_mode_switch_handle_track{width:188px!important;height:18px!important;position:absolute!important;top:0!important;left:-47px!important}#sv #sv_mode_switch_handle{width:141px!important;height:18px!important;background:url("data:image/png;charset=utf-8;base64,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") no-repeat!important;position:absolute!important;top:0!important}*+html #sv_mode_switch_handle{background:url(http://cdn.sublimevideo.net/p/ie/handle_and_labels.png) no-repeat!important}* html #sv_mode_switch_handle{background:none!important;filter:progid:DXImageTransform.Microsoft.AlphaImageLoader(src="http://cdn.sublimevideo.net/p/ie/handle_and_labels.png")!important}#sv #sublime_zoom{position:absolute!important;top:0!important;left:0!important;width:auto!important;height:auto!important;z-index:999998!important}#sv #sz_close_button{padding:0!important;margin:0!important;border:none!important;width:45px!important;height:45px!important;position:absolute!important;cursor:pointer!important;z-index:4!important;opacity:0!important;-webkit-transition:opacity .4s!important;-moz-transition:opacity .4s!important;-o-transition:opacity .4s!important;transition:opacity .4s!important;display:none\9!important}* html #sz_close_button{display:block!important}#sv #sz_content_wrapper:hover #sz_close_button{opacity:1!important;display:block\9!important}</style></body></html>